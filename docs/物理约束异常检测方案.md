# 基于物理约束的异常值检测方案

## 📋 背景与问题

### 原有方案的局限性

之前采用的 **IQR（四分位距）统计方法** 存在以下问题：

1. **误判正常峰值**：989 W/m² 的辐照度（正常晴天值）被标记为异常
2. **误判装机容量附近的功率**：48MW（接近50MW装机容量）被标记为异常
3. **忽视物理规律**：湿度100%（物理合理的极端值）被标记为异常
4. **缺乏领域知识**：纯统计方法无法理解光伏系统的物理特性

### 核心问题

> **光伏数据遵循明确的物理规律，不应用纯统计方法判断异常**

---

## 🎯 改进方案：三层异常检测体系

### 方案架构

```
异常值检测系统
├── 第一层：错误标记检测
│   └── 识别明确的缺失值标记（-99, -999, -9999）
├── 第二层：物理约束检测
│   ├── power: [0, 55000] kW
│   ├── irradiance: [0, 1200] W/m²
│   ├── temperature: [-40, 60] °C
│   ├── pressure: [850, 1100] hPa
│   └── humidity: [0, 100] %
└── 第三层：统计方法（可选）
    ├── IQR：用于非物理数据
    └── Z-score：用于非物理数据
```

---

## 🔧 技术实现

### 1. 配置文件更新 (`config/data_config.yaml`)

```yaml
preprocessing:
  outlier_detection:
    method: "physical"         # 检测方法：physical/iqr/zscore
    apply_to: ["power", "irradiance", "temperature", "pressure", "humidity"]
    
    # 物理约束范围（基于领域知识）
    physical_ranges:
      power: [0, 55000]        # kW，装机容量50MW + 10%过载保护
      irradiance: [0, 1200]    # W/m²，地面太阳辐照度物理上限
      temperature: [-40, 60]   # °C，极端气候范围
      pressure: [850, 1100]    # hPa，考虑海拔1500m的气压范围
      humidity: [0, 100]       # %，相对湿度的物理范围
    
    # 错误标记值（将被视为缺失值）
    error_markers: [-99, -999, -9999]
```

### 2. 物理范围的科学依据

| 变量 | 范围 | 依据 |
|------|------|------|
| **power** | [0, 55000] kW | 装机容量50MW + 10%过载保护 |
| **irradiance** | [0, 1200] W/m² | 地面辐照度理论上限（标准大气质量，晴朗天空） |
| **temperature** | [-40, 60] °C | 中国气候极值范围（含甘肃地区） |
| **pressure** | [850, 1100] hPa | 海拔1500m对应的气压范围 |
| **humidity** | [0, 100] % | 相对湿度的物理定义范围 |

### 3. 核心代码实现 (`src/data_processing/data_loader.py`)

#### 物理约束检测逻辑

```python
def _detect_outliers(self, series: pd.Series, method: str = 'physical') -> Dict[str, Any]:
    """
    基于物理约束的异常检测
    
    检测策略：
    1. 优先检测错误标记值（-99, -999, -9999）
    2. 检测超出物理范围的值
    3. 分类统计：错误标记数量 vs 范围违规数量
    """
    if method == 'physical':
        # 第一层：错误标记检测
        error_markers = self.config.get('error_markers', [-99, -999, -9999])
        error_mask = series.isin(error_markers)
        
        # 第二层：物理范围检测
        physical_ranges = self.config.get('physical_ranges', {})
        column_name = series.name
        
        if column_name in physical_ranges:
            lower_bound, upper_bound = physical_ranges[column_name]
            range_mask = (series < lower_bound) | (series > upper_bound)
            outlier_mask = error_mask | range_mask
        else:
            # 未定义物理范围的变量，仅检测错误标记
            outlier_mask = error_mask
        
        return {
            'indices': series[outlier_mask].index,
            'count': outlier_mask.sum(),
            'error_marker_count': error_mask.sum(),
            'range_violation_count': range_mask.sum(),
            'method': 'physical_constraint',
            'bounds': [lower_bound, upper_bound]
        }
```

---

## 📊 对比分析

### 方案对比

| 特性 | IQR统计方法 | 物理约束方法 |
|------|-------------|--------------|
| **理论基础** | 统计分布 | 物理定律 + 领域知识 |
| **适用场景** | 非物理数据 | 光伏、气象等物理数据 |
| **误判风险** | 高（峰值易误判） | 低（基于物理真实性） |
| **可解释性** | 弱（统计概念） | 强（物理意义明确） |
| **参数设置** | 需调参（阈值敏感） | 固定（基于物理定律） |

### 实际效果举例

| 数值 | IQR方法 | 物理约束方法 | 说明 |
|------|---------|--------------|------|
| 辐照度 989 W/m² | ❌ 异常 | ✅ 正常 | 晴天峰值，符合物理规律 |
| 功率 48000 kW | ❌ 异常 | ✅ 正常 | 接近装机容量，合理 |
| 湿度 100% | ❌ 异常 | ✅ 正常 | 饱和状态，物理可能 |
| 辐照度 1500 W/m² | ✅ 正常 | ❌ 异常 | 超过地面物理上限 |
| 功率 -99 kW | ⚠️ 异常 | ❌ 错误标记 | 明确的缺失值标记 |

---

## 🚀 使用指南

### 1. 启用物理约束检测

在 `config/data_config.yaml` 中设置：

```yaml
preprocessing:
  outlier_detection:
    method: "physical"  # 使用物理约束方法
```

### 2. 自定义物理范围

根据具体站点调整范围：

```yaml
physical_ranges:
  power: [0, 110000]      # 针对100MW装机容量的站点
  irradiance: [0, 1200]   # 保持标准上限
  temperature: [-20, 50]  # 针对温带地区
```

### 3. 切换回统计方法（不推荐）

如果需要使用统计方法：

```yaml
preprocessing:
  outlier_detection:
    method: "iqr"        # 或 "zscore"
    iqr_threshold: 1.5
```

---

## 📈 预期效果

### 1. 数据质量提升

- **减少误判**：正常峰值不再被标记为异常
- **保留有效数据**：更多物理合理的数据用于训练
- **提高模型性能**：训练数据更符合真实分布

### 2. 可解释性增强

- **物理意义明确**：每个阈值都有物理依据
- **易于审查**：领域专家可直接验证范围合理性
- **便于调试**：异常数据的原因清晰可追溯

### 3. 系统鲁棒性

- **自适应不同站点**：通过配置文件灵活调整
- **兼容未来扩展**：保留统计方法作为备选
- **向后兼容**：不影响现有代码的其他部分

---

## 🔍 验证方法

### 数据质量报告示例

```
异常值检测报告（物理约束方法）
================================
变量: power
方法: physical_constraint
物理范围: [0, 55000] kW
--------------------------------
总样本数: 70,080
检测到异常: 12 (0.02%)
  - 错误标记: 8 (-99标记)
  - 范围违规: 4 (>55000 kW)
--------------------------------
异常样本预览:
  2023-01-05 03:00 → -99 kW (错误标记)
  2023-03-12 12:15 → 56,200 kW (超过装机容量)
```

---

## 📝 维护建议

1. **定期审查物理范围**：结合站点实际运行数据调整
2. **记录异常案例**：分析被标记的异常值是否合理
3. **与领域专家沟通**：确保物理约束符合最新工程实践
4. **监控数据分布**：观察删除异常后的数据分布变化

---

## 🎓 参考文献

1. **太阳辐照度标准**：ASTM G173-03 Standard Tables for Reference Solar Spectral Irradiances
2. **光伏系统设计**：IEC 61724-1:2017 Photovoltaic system performance monitoring
3. **气象数据标准**：WMO Technical Regulations (World Meteorological Organization)

---

## 📌 总结

✅ **核心改进**：从统计驱动转向领域知识驱动  
✅ **关键优势**：减少误判，提高数据利用率  
✅ **实施简单**：配置文件即可切换方法  
✅ **向后兼容**：保留原有统计方法作为备选  

> **建议**：对于所有涉及物理测量的数据（气象、能源、工业传感器等），优先使用物理约束方法进行异常检测。

